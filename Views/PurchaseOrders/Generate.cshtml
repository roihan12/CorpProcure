@using CorpProcure.DTOs.PurchaseOrder
@using CorpProcure.Models
@using CorpProcure.Models.Enums
@model GeneratePoDto
@{
    ViewData["Title"] = "Generate Purchase Order";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var request = ViewBag.RequestDetails as PurchaseRequest;
}

<div class="main-content-container overflow-hidden">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <h3 class="mb-0">Generate Purchase Order (Draft)</h3>

        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center mb-0 lh-1">
                <li class="breadcrumb-item">
                    <a asp-controller="Home" asp-action="Index" class="d-flex align-items-center text-decoration-none">
                        <i class="ri-home-4-line fs-18 text-primary me-1"></i>
                        <span class="text-secondary fw-medium hover">Dashboard</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-controller="PurchaseOrders" asp-action="Index" class="d-flex align-items-center text-decoration-none">
                        <span class="text-secondary fw-medium hover">Purchase Orders</span>
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <span class="fw-medium">Generate PO</span>
                </li>
            </ol>
        </nav>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="ri-error-warning-line me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <form asp-action="GenerateConfirmed" method="post" id="poForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PurchaseRequestId" />
        
        <div class="row">
            <!-- Left Column: PO Details -->
            <div class="col-lg-8">
                <div class="card bg-white border-0 rounded-3 mb-4">
                    <div class="card-header bg-transparent border-bottom p-4">
                        <h5 class="mb-0">Purchase Request Reference: @request?.RequestNumber</h5>
                        <small class="text-muted">Requester: @request?.Requester?.FullName | Department: @request?.Department?.Name</small>
                    </div>
                    
                    <div class="card-body p-4">
                        <!-- Logistics -->
                        <h6 class="fw-bold mb-3 text-primary">Logistics & Delivery</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="ShippingAddress" class="form-label fw-medium"></label>
                                <textarea asp-for="ShippingAddress" class="form-control" rows="3" placeholder="Enter delivery address..."></textarea>
                                <span asp-validation-for="ShippingAddress" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="BillingAddress" class="form-label fw-medium"></label>
                                <textarea asp-for="BillingAddress" class="form-control" rows="3" placeholder="Enter billing address..."></textarea>
                                <span asp-validation-for="BillingAddress" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Items Grid -->
                        <h6 class="fw-bold mb-3 text-primary">Order Items & Pricing</h6>
                        <div class="table-responsive mb-4">
                            <table class="table align-middle table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item Name</th>
                                        <th class="text-center" width="100">Qty</th>
                                        <th width="180">Unit Price (@Model.Currency)</th>
                                        <th class="text-end" width="180">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.Items.Count; i++)
                                    {
                                        <tr>
                                            <td>
                                                <input type="hidden" asp-for="Items[i].RequestItemId" />
                                                <input type="hidden" asp-for="Items[i].ItemId" />
                                                <input type="hidden" asp-for="Items[i].ItemName" />
                                                <input type="hidden" asp-for="Items[i].Description" />
                                                <input type="hidden" asp-for="Items[i].Quantity" /> <!-- Assume Qty is fixed from PR -->
                                                
                                                <div class="d-flex flex-column">
                                                    <span class="fw-medium">@Model.Items[i].ItemName</span>
                                                    <small class="text-muted text-truncate" style="max-width: 250px;">@Model.Items[i].Description</small>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark fs-6 border">@Model.Items[i].Quantity</span>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Rp</span>
                                                    <input asp-for="Items[i].UnitPrice" class="form-control text-end item-price" data-qty="@Model.Items[i].Quantity" type="number" step="0.01" />
                                                </div>
                                            </td>
                                            <td class="text-end fw-bold item-total">
                                                Rp 0
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label fw-medium"></label>
                            <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Special instructions for the vendor..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Settings & Financials -->
            <div class="col-lg-4">
                <!-- General Settings -->
                <div class="card bg-white border-0 rounded-3 mb-4">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-3">General Settings</h6>
                        
                        <div class="mb-3">
                            <label asp-for="VendorId" class="form-label fw-medium">Select Vendor <span class="text-danger">*</span></label>
                            <select asp-for="VendorId" asp-items="ViewBag.Vendors" class="form-select" required>
                                <option value="">-- Select Vendor --</option>
                            </select>
                            <span asp-validation-for="VendorId" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PoDate" class="form-label fw-medium"></label>
                            <input asp-for="PoDate" class="form-control" type="date" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="QuotationReference" class="form-label fw-medium"></label>
                            <input asp-for="QuotationReference" class="form-control" placeholder="e.g. Q-2024-001" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="PaymentTerms" class="form-label fw-medium"></label>
                            <select asp-for="PaymentTerms" asp-items="Html.GetEnumSelectList<PaymentTermType>()" class="form-select"></select>
                        </div>

                         <div class="mb-3">
                            <label asp-for="ExpectedDeliveryDate" class="form-label fw-medium"></label>
                            <input asp-for="ExpectedDeliveryDate" class="form-control" type="date" />
                        </div>
                    </div>
                </div>

                <!-- Budget Info Card -->
                @if (ViewBag.BudgetInfo != null)
                {
                    var budgetInfo = ViewBag.BudgetInfo;
                    <div class="card bg-white border-0 rounded-3 mb-4">
                        <div class="card-header bg-transparent border-bottom p-3">
                            <h6 class="mb-0 fw-bold">
                                <i class="ri-wallet-3-line text-success me-2"></i>Department Budget (@budgetInfo.Year)
                            </h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Department</span>
                                <span class="fw-medium">@budgetInfo.DepartmentName</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Total Budget</span>
                                <span class="fw-bold text-dark">Rp @string.Format("{0:N0}", budgetInfo.TotalBudget)</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Used</span>
                                <span class="text-secondary">Rp @string.Format("{0:N0}", budgetInfo.CurrentUsage)</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Reserved</span>
                                <span class="text-warning">Rp @string.Format("{0:N0}", budgetInfo.Reserved)</span>
                            </div>
                            <hr class="my-2" />
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Available</span>
                                <span class="fw-bold text-success fs-5">Rp @string.Format("{0:N0}", budgetInfo.Available)</span>
                            </div>
                            <div class="progress mt-3" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: @budgetInfo.UsedPercentage%"
                                     aria-valuenow="@budgetInfo.UsedPercentage" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">@budgetInfo.UsedPercentage% of budget used</small>
                        </div>
                    </div>
                }

                <!-- Financial Summary -->
                <div class="card bg-white border-0 rounded-3 mb-4">
                    <div class="card-body p-4 bg-light">
                        <h6 class="fw-bold mb-3">Financials</h6>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span class="fw-bold" id="displaySubtotal">Rp 0</span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="TaxRate" class="form-label small text-muted mb-1">Tax Rate (%)</label>
                            <div class="input-group input-group-sm">
                                <input asp-for="TaxRate" class="form-control text-end calc-input" type="number" step="0.01" />
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax Amount</span>
                            <span class="text-danger" id="displayTax">Rp 0</span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="ShippingCost" class="form-label small text-muted mb-1">Shipping Cost</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="ShippingCost" class="form-control text-end calc-input" type="number" step="0.01" />
                            </div>
                        </div>

                        <div class="mb-2">
                            <label asp-for="Discount" class="form-label small text-muted mb-1">Discount</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Rp</span>
                                <input asp-for="Discount" class="form-control text-end calc-input" type="number" step="0.01" />
                            </div>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fs-5 fw-bold text-dark">Grand Total</span>
                            <span class="fs-5 fw-bold text-primary" id="displayGrandTotal">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary py-2 fw-medium" id="generateBtn">
                        <i class="ri-file-text-line me-1"></i> Generate Draft PO
                    </button>
                    <button type="button" class="btn btn-outline-secondary py-2 fw-medium" 
                            onclick="showConfirm('Are you sure you want to discard your changes?', () => window.location.href='@Url.Action("Index")')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fs-18 fw-bold">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-3 pb-4">
                <p id="confirmationMessage" class="fs-15 mb-0 text-secondary"></p>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-light fw-medium px-4" data-bs-dismiss="modal">No, Cancel</button>
                <button type="button" class="btn btn-primary fw-medium text-white px-4" id="confirmActionBtn">Yes, Proceed</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let confirmModal;
        let onConfirm = null;

        document.addEventListener('DOMContentLoaded', function() {
            confirmModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            
            document.getElementById('confirmActionBtn').addEventListener('click', function() {
                if (onConfirm) onConfirm();
                confirmModal.hide();
            });
        });

        function showConfirm(message, callback) {
            document.getElementById('confirmationMessage').textContent = message;
            onConfirm = callback;
            confirmModal.show();
        }

        $(document).ready(function() {
            function formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            }

            function calculateTotals() {
                let subtotal = 0;

                // Calculate Line Items
                $('.item-price').each(function() {
                    let qty = parseFloat($(this).data('qty')) || 0;
                    let price = parseFloat($(this).val()) || 0;
                    let total = qty * price;
                    
                    subtotal += total;
                    
                    // Update line total display
                    $(this).closest('tr').find('.item-total').text(formatCurrency(total));
                });

                // Get Global Values
                let taxRate = parseFloat($('#TaxRate').val()) || 0;
                let shippingCost = parseFloat($('#ShippingCost').val()) || 0;
                let discount = parseFloat($('#Discount').val()) || 0;

                // Calculate Finals
                let taxAmount = subtotal * (taxRate / 100);
                let grandTotal = subtotal + taxAmount + shippingCost - discount;

                // Update Displays
                $('#displaySubtotal').text(formatCurrency(subtotal));
                $('#displayTax').text(formatCurrency(taxAmount));
                $('#displayGrandTotal').text(formatCurrency(grandTotal));
            }

            // Bind events
            $('.item-price, .calc-input').on('input change', function() {
                calculateTotals();
            });

            // Initial calculation
            calculateTotals();

            // Vendor price auto-fill
            $('#VendorId').on('change', async function() {
                const vendorId = $(this).val();
                if (!vendorId) return;

                // Collect item IDs
                const itemIds = [];
                $('input[name$=".ItemId"]').each(function() {
                    const id = $(this).val();
                    if (id && id !== '00000000-0000-0000-0000-000000000000') {
                        itemIds.push(id);
                    }
                });

                if (itemIds.length === 0) {
                    console.log('No catalog items to fetch prices for');
                    return;
                }

                // Show loading indicator
                const vendorSelect = $(this);
                vendorSelect.prop('disabled', true);

                try {
                    const response = await fetch(`/api/VendorItems/prices/${vendorId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ itemIds: itemIds })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.prices) {
                        let updatedCount = 0;
                        
                        $('input[name$=".ItemId"]').each(function(index) {
                            const itemId = $(this).val();
                            const priceInput = $(`input[name="Items[${index}].UnitPrice"]`);
                            
                            if (itemId && data.prices[itemId]) {
                                const oldPrice = parseFloat(priceInput.val()) || 0;
                                const newPrice = data.prices[itemId];
                                
                                // Only update if different and add visual indicator
                                if (oldPrice !== newPrice) {
                                    priceInput.val(newPrice);
                                    priceInput.addClass('border-success');
                                    priceInput.attr('title', `Contract price: Rp ${newPrice.toLocaleString('id-ID')}`);
                                    updatedCount++;
                                    
                                    // Remove highlight after 3 seconds
                                    setTimeout(() => {
                                        priceInput.removeClass('border-success');
                                    }, 3000);
                                }
                            }
                        });

                        if (updatedCount > 0) {
                            showToast('success', `Updated ${updatedCount} item(s) with vendor contract prices`);
                            calculateTotals();
                        }
                    }
                } catch (error) {
                    console.error('Error fetching vendor prices:', error);
                } finally {
                    vendorSelect.prop('disabled', false);
                }
            });

            // Toast notification helper
            function showToast(type, message) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
                const toast = $(`
                    <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3" style="z-index: 9999;">
                        <i class="ri-checkbox-circle-line me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                $('body').append(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // Handle Generate Button
            $('#generateBtn').click(function() {
                if ($('#poForm').valid()) {
                    showConfirm('Generate Purchase Order?', function() {
                        const form = $('#poForm');
                        const btn = $('#generateBtn');
                        
                        // Show loading state
                        btn.prop('disabled', true);
                        btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
                        
                        // Submit logic is handled by standard form submission after valid check
                        // But since we are inside a callback, we need to bypass 'click' and submit directly
                        // Or trigger native submit
                        form[0].submit();
                    });
                } else {
                     // Trigger validation messages
                    $('#poForm').validate().focusInvalid();
                }
            });
        });
    </script>
}
