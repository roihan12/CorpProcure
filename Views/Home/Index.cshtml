@using CorpProcure.Models.Enums
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    
    // Get dashboard stats from ViewData
    var stats = ViewData["DashboardStats"] as dynamic;
    var statusDistribution = ViewData["StatusDistribution"] as IEnumerable<dynamic>;
    var departmentSpending = ViewData["DepartmentSpending"] as IEnumerable<dynamic>;
    var monthlyTrend = ViewData["MonthlyTrend"] as IEnumerable<dynamic>;
    var budgetUtilization = ViewData["BudgetUtilization"] as IEnumerable<dynamic>;
    var recentRequests = ViewData["RecentRequests"] as IEnumerable<dynamic>;
    var pendingApprovals = ViewData["PendingApprovals"] as IEnumerable<dynamic>;
    
    // New analytics data
    var topVendors = ViewData["TopVendors"] as IEnumerable<dynamic>;
    var avgProcessingDays = ViewData["AvgProcessingDays"];
    var yoyComparison = ViewData["YoYComparison"] as dynamic;
    var spendingByCategory = ViewData["SpendingByCategory"] as IEnumerable<dynamic>;
    
    bool hasError = ViewData["Error"] != null;
}

<style>
    .stats-icon {
        width: 60px;
        height: 60px;
        line-height: 60px;
    }
</style>

<div class="main-content-container overflow-hidden">
    @if (hasError)
    {
        <div class="alert alert-warning mb-4">
            <i class="ri-error-warning-line me-2"></i>
            Some dashboard data couldn't be loaded. Please try refreshing the page or contact support if the issue persists.
        </div>
    }
    
    <div class="row">
        <div class="col-lg-6">
            <div class="row">
                <!-- Pending Requests -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 mb-4"
                        style="background: linear-gradient(108deg, #3A4252 0%, #23272E 100%);">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span
                                    class="d-inline-block px-3 bg-warning bg-opacity-25 text-warning border border-warning rounded-pill fs-12 fw-medium">Pending</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12" style="color: #B1BBC8;">Awaiting Approval</span>
                                    <span class="fs-12 fw-bold text-warning d-block">@(stats?.PendingManager ?? 0) Manager | @(stats?.PendingFinance ?? 0) Finance</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1" style="color: #B1BBC8;">Pending Requests</span>
                                    <h4 class="fs-20 mb-0 text-white">@(stats?.TotalPending ?? 0)</h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-time-line fs-24 text-warning bg-warning d-inline-block text-center rounded-circle text-white stats-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Approved This Month -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 bg-white mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span
                                    class="d-inline-block px-3 bg-success bg-opacity-10 text-success border border-success rounded-pill fs-12 fw-medium">+@(stats?.ApprovedGrowth ?? 0)%</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12">This Month</span>
                                    <span class="fs-12 fw-bold text-success d-block">@(stats?.ApprovedThisMonth ?? 0) approved</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1">Approved Requests</span>
                                    <h4 class="fs-20 mb-0">@(stats?.TotalApproved ?? 0)</h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-checkbox-circle-line fs-24 text-white bg-success d-inline-block text-center rounded-circle text-white stats-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Amount This Month -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 bg-white mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span
                                    class="d-inline-block px-3 bg-primary bg-opacity-10 text-primary border border-primary rounded-pill fs-12 fw-medium">This Month</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12">vs Last Month</span>
                                    <span class="fs-12 fw-bold text-primary d-block">+@(stats?.AmountGrowth ?? 0)%</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1">Total Amount</span>
                                    <h4 class="fs-20 mb-0">Rp @(stats?.TotalAmountThisMonth?.ToString("N0") ?? "0")</h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-money-dollar-circle-line fs-24 text-white bg-primary d-inline-block text-center rounded-circle text-white stats-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rejected Requests -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 bg-white mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span
                                    class="d-inline-block px-3 bg-danger bg-opacity-10 text-danger border border-danger rounded-pill fs-12 fw-medium">This Month</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12">Rejection Rate</span>
                                    <span class="fs-12 fw-bold text-danger d-block">@(stats?.RejectionRate ?? 0)%</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1">Rejected Requests</span>
                                    <h4 class="fs-20 mb-0">@(stats?.RejectedThisMonth ?? 0)</h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-close-circle-line fs-24 text-white bg-danger d-inline-block text-center rounded-circle text-white stats-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avg Processing Time -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 bg-white mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span
                                    class="d-inline-block px-3 bg-info bg-opacity-10 text-info border border-info rounded-pill fs-12 fw-medium">Efficiency</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12">Avg. Approval Time</span>
                                    <span class="fs-12 fw-bold text-info d-block">From Submit to Approved</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1">Processing Days</span>
                                    <h4 class="fs-20 mb-0">@(avgProcessingDays ?? 0) <small class="fs-14 text-muted">days</small></h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-timer-line fs-24 text-white bg-info d-inline-block text-center rounded-circle text-white stats-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- YoY Comparison -->
                <div class="col-sm-6">
                    <div class="card border-0 rounded-3 bg-white mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                @{
                                    var yoyGrowthVal = yoyComparison?.Growth ?? 0;
                                    var yoyBadgeClass = yoyGrowthVal >= 0 ? "bg-success bg-opacity-10 text-success border-success" : "bg-danger bg-opacity-10 text-danger border-danger";
                                    var yoySign = yoyGrowthVal >= 0 ? "+" : "";
                                }
                                <span class="d-inline-block px-3 @yoyBadgeClass border rounded-pill fs-12 fw-medium">@yoySign@yoyGrowthVal%</span>
                                <div class="text-end">
                                    <span class="ms-2 fs-12">Year over Year</span>
                                    <span class="fs-12 fw-bold d-block">vs @(DateTime.Now.Year - 1)</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1">
                                    <span class="d-block mb-1">This Year Spending</span>
                                    <h4 class="fs-20 mb-0">Rp @((yoyComparison?.ThisYearTotal ?? 0).ToString("N0"))</h4>
                                </div>
                                <div class="flex-shrink-0 me-3 me-auto">
                                    <i class="ri-line-chart-line fs-24 text-white bg-purple d-inline-block text-center rounded-circle text-white stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 rounded-3 bg-white mb-4" style="height: 100%;">
                <div class="card-body p-4">
                    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
                        <h3 class="mb-0">Request Status Distribution</h3>
                        <span class="fs-12">All Time</span>
                    </div>

                    <div id="request_status_chart" style="height: 280px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-xxl-8">
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 rounded-3 bg-white mb-4" style="height: 400px;">
                        <div class="card-body p-4 h-100 d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
                                <span>Monthly Request Trend</span>
                                <span class="fs-12">Per Month</span>
                            </div>
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center" style="margin: -24px -22px -26px -18px;">
                                <canvas id="monthly_trend_chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 rounded-3 bg-white mb-4" style="height: 400px;">
                        <div class="card-body p-4 h-100 d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
                                <span>Department Spending</span>
                                <span class="fs-12">This Month</span>
                            </div>
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center" style="margin: -24px -6px -25px -17px;">
                                <div id="department_spending_chart" style="width:100%;height:100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Vendors Row -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 rounded-3 bg-white mb-4" style="height: 350px;">
                        <div class="card-body p-4 h-100 d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
                                <span><i class="ri-store-2-line me-1"></i> Top 5 Vendors</span>
                                <span class="fs-12">By Spending</span>
                            </div>
                            <div class="flex-grow-1">
                                <div id="top_vendors_chart" style="width:100%;height:100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 rounded-3 bg-white mb-4" style="height: 350px;">
                        <div class="card-body p-4 h-100 d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
                                <span><i class="ri-pie-chart-line me-1"></i> Spending by Category</span>
                                <span class="fs-12">All Time</span>
                            </div>
                            <div class="flex-grow-1">
                                <div id="category_spending_chart" style="width:100%;height:100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-white border-0 rounded-3 mb-4">
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-4">
                        <h3 class="mb-0">Recent Purchase Requests</h3>
                        <a asp-controller="PurchasesRequest" asp-action="Index" class="btn btn-outline-primary btn-sm">
                            View All <i class="ri-arrow-right-line ms-1"></i>
                        </a>
                    </div>

                    <div class="default-table-area style-two transaction-history tracking-order">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th scope="col">Request #</th>
                                        <th scope="col">Requester</th>
                                        <th scope="col">Department</th>
                                        <th scope="col">Title</th>
                                        <th scope="col">Amount</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (recentRequests != null && recentRequests.Any())
                                    {
                                        foreach (var request in recentRequests.Take(5))
                                        {
                                            <tr>
                                                <td class="text-body">@request.RequestNumber</td>
                                                <td class="text-body">@request.RequesterName</td>
                                                <td class="text-body">@request.DepartmentName</td>
                                                <td>
                                                    <a asp-controller="PurchasesRequest" asp-action="Details" asp-route-id="@request.Id" class="text-body">
                                                        @request.Title
                                                    </a>
                                                </td>
                                                <td class="text-body">Rp @request.TotalAmount.ToString("N0")</td>
                                                <td>
                                                    @{
                                                        var statusClass = request.Status switch
                                                        {
                                                            RequestStatus.Draft => "bg-secondary bg-opacity-10 text-secondary",
                                                            RequestStatus.PendingManager => "bg-warning bg-opacity-10 text-warning",
                                                            RequestStatus.PendingFinance => "bg-info bg-opacity-10 text-info",
                                                            RequestStatus.Approved => "bg-success bg-opacity-10 text-success",
                                                            RequestStatus.Rejected => "bg-danger bg-opacity-10 text-danger",
                                                            RequestStatus.Cancelled => "bg-dark bg-opacity-10 text-dark",
                                                            _ => "bg-secondary bg-opacity-10 text-secondary"
                                                        };
                                                        var statusText = request.Status switch
                                                        {
                                                            RequestStatus.Draft => "Draft",
                                                            RequestStatus.PendingManager => "Pending Manager",
                                                            RequestStatus.PendingFinance => "Pending Finance",
                                                            RequestStatus.Approved => "Approved",
                                                            RequestStatus.Rejected => "Rejected",
                                                            RequestStatus.Cancelled => "Cancelled",
                                                            _ => "Unknown"
                                                        };
                                                    }
                                                    <span class="badge @statusClass p-2 fs-12 fw-normal">@statusText</span>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="ri-inbox-line fs-24 d-block mb-2"></i>
                                                No recent requests found
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-4">
            <div class="card bg-white border-0 rounded-3 mb-4">
                <div class="card-body p-4">
                    <h3 class="mb-4">Pending Approvals</h3>
                    <div id="pendingApprovalsList">
                        @if (pendingApprovals != null && pendingApprovals.Any())
                        {
                            foreach (var approval in pendingApprovals.Take(5))
                            {
                                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                    <div class="flex-shrink-0">
                                        <i class="ri-file-list-3-line wh-40 lh-40 d-inline-block bg-primary bg-opacity-10 text-center fs-18 text-primary rounded-circle"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 fs-14">@approval.RequestNumber</h6>
                                        <span class="fs-12 text-muted">@approval.RequesterName - Rp @approval.TotalAmount.ToString("N0")</span>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <a asp-controller="PurchasesRequest" asp-action="Approve" asp-route-id="@approval.Id" class="btn btn-sm btn-outline-primary">
                                            Review
                                        </a>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="ri-checkbox-circle-line fs-24 d-block mb-2"></i>
                                No pending approvals
                            </div>
                        }
                    </div>
                    @if (pendingApprovals != null && pendingApprovals.Count() > 5)
                    {
                        <div class="text-center mt-4">
                            <a asp-controller="PurchasesRequest" asp-action="MyApprovals" class="btn btn-outline-primary btn-sm">
                                <i class="ri-eye-line me-1"></i> View All Approvals (@pendingApprovals.Count())
                            </a>
                        </div>
                    }
                </div>
            </div>
            
            <div class="card bg-white border-0 rounded-3 mb-4">
                <div class="card-body p-4">
                    <h3 class="mb-4">Budget Utilization</h3>
                    <div id="budget_utilization_chart" style="height: 300px;"></div>
                    
                    <div class="mt-4">
                        @if (budgetUtilization != null)
                        {
                            foreach (var dept in budgetUtilization.Take(4))
                            {
                                var utilization = dept.Budget > 0 ? (dept.Used / dept.Budget * 100) : 0;
                                var progressClass = utilization > 90 ? "bg-danger" : utilization > 70 ? "bg-warning" : "bg-success";
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fs-13">@dept.DepartmentName</span>
                                        <span class="fs-13 fw-medium">@utilization.ToString("N0")%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar @progressClass" role="progressbar" style="width: @utilization%" aria-valuenow="@utilization" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Request Status Distribution Chart (Donut Chart)
                var statusChartElement = document.querySelector("#request_status_chart");
                if (statusChartElement) {
                    var requestStatusOptions = {
                        series: [
                            @if (statusDistribution != null && statusDistribution.Any())
                            {
                                @Html.Raw(string.Join(", ", statusDistribution.Select(s => s.Count)))
                            }
                            else
                            {
                                <text>10, 15, 8, 25, 5, 3</text>
                            }
                        ],
                        chart: {
                            type: 'donut',
                            height: 300
                        },
                        labels: [
                            @if (statusDistribution != null && statusDistribution.Any())
                            {
                                @Html.Raw(string.Join(", ", statusDistribution.Select(s => $"'{s.Status}'")))
                            }
                            else
                            {
                                <text>'Draft', 'Pending Manager', 'Pending Finance', 'Approved', 'Rejected', 'Cancelled'</text>
                            }
                        ],
                        colors: ['#6c757d', '#ffc107', '#17a2b8', '#28a745', '#dc3545', '#343a40'],
                        legend: {
                            position: 'bottom'
                        },
                        responsive: [{
                            breakpoint: 480,
                            options: {
                                chart: {
                                    height: 260
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }]
                    };
                    
                    try {
                        var requestStatusChart = new ApexCharts(statusChartElement, requestStatusOptions);
                        requestStatusChart.render();
                    } catch (err) {
                        console.error("Error rendering Request Status chart:", err);
                        statusChartElement.innerHTML = "<div class='alert alert-danger'>Could not load chart</div>";
                    }
                }
                
                // Department Spending Chart (Pie Chart)
                var deptChartElement = document.querySelector("#department_spending_chart");
                if (deptChartElement) {
                    var departmentSpendingOptions = {
                        series: [
                            @if (departmentSpending != null && departmentSpending.Any())
                            {
                                @Html.Raw(string.Join(", ", departmentSpending.Select(d => d.TotalSpending)))
                            }
                            else
                            {
                                <text>35000000, 28000000, 22000000, 15000000</text>
                            }
                        ],
                        chart: {
                            type: 'pie',
                            height: 300
                        },
                        labels: [
                            @if (departmentSpending != null && departmentSpending.Any())
                            {
                                @Html.Raw(string.Join(", ", departmentSpending.Select(d => $"'{d.DepartmentName}'")))
                            }
                            else
                            {
                                <text>'IT', 'HR', 'Marketing', 'Operations'</text>
                            }
                        ],
                        colors: ['#6259ca', '#28a745', '#ffc107', '#17a2b8'],
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            y: {
                                formatter: function(val) {
                                    return 'Rp ' + val.toLocaleString('id-ID');
                                }
                            }
                        },
                        responsive: [{
                            breakpoint: 480,
                            options: {
                                chart: {
                                    height: 260
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }]
                    };
                    
                    try {
                        var departmentSpendingChart = new ApexCharts(deptChartElement, departmentSpendingOptions);
                        departmentSpendingChart.render();
                    } catch (err) {
                        console.error("Error rendering Department Spending chart:", err);
                        deptChartElement.innerHTML = "<div class='alert alert-danger'>Could not load chart</div>";
                    }
                }
                
                // Budget Utilization Chart
                var budgetChartElement = document.querySelector("#budget_utilization_chart");
                if (budgetChartElement) {
                    var budgetUtilizationOptions = {
                        series: [{
                            name: 'Used',
                            data: [
                                @if (budgetUtilization != null && budgetUtilization.Any())
                                {
                                    @Html.Raw(string.Join(", ", budgetUtilization.Select(b => b.Used)))
                                }
                                else
                                {
                                    <text>75000000, 50000000, 30000000, 25000000</text>
                                }
                            ]
                        }],
                        chart: {
                            type: 'bar',
                            height: 300,
                            toolbar: {
                                show: false
                            }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: true,
                                columnWidth: '55%',
                                borderRadius: 4,
                            },
                        },
                        colors: ['#6259ca'],
                        dataLabels: {
                            enabled: false
                        },
                        xaxis: {
                            categories: [
                                @if (budgetUtilization != null && budgetUtilization.Any())
                                {
                                    @Html.Raw(string.Join(", ", budgetUtilization.Select(b => $"'{b.DepartmentName}'")))
                                }
                                else
                                {
                                    <text>'IT', 'HR', 'Marketing', 'Operations'</text>
                                }
                            ],
                            labels: {
                                formatter: function(val) {
                                    return 'Rp ' + (val / 1000000).toFixed(0) + 'M';
                                }
                            }
                        },
                        yaxis: {
                            title: {
                                text: ''
                            }
                        },
                        tooltip: {
                            y: {
                                formatter: function(val) {
                                    return 'Rp ' + val.toLocaleString('id-ID');
                                }
                            }
                        },
                        fill: {
                            opacity: 1
                        }
                    };
                    
                    try {
                        var budgetUtilizationChart = new ApexCharts(budgetChartElement, budgetUtilizationOptions);
                        budgetUtilizationChart.render();
                    } catch (err) {
                        console.error("Error rendering Budget Utilization chart:", err);
                        budgetChartElement.innerHTML = "<div class='alert alert-danger'>Could not load chart</div>";
                    }
                }

                // Top 5 Vendors Chart (Horizontal Bar)
                var topVendorsChartElement = document.querySelector("#top_vendors_chart");
                if (topVendorsChartElement) {
                    var topVendorsOptions = {
                        series: [{
                            name: 'Total Spending',
                            data: [
                                @if (topVendors != null && topVendors.Any())
                                {
                                    @Html.Raw(string.Join(", ", topVendors.Select(v => v.TotalSpending)))
                                }
                                else
                                {
                                    <text>0</text>
                                }
                            ]
                        }],
                        chart: {
                            type: 'bar',
                            height: 280,
                            toolbar: { show: false }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: true,
                                borderRadius: 4,
                                barHeight: '70%'
                            }
                        },
                        colors: ['#28a745'],
                        dataLabels: { enabled: false },
                        xaxis: {
                            categories: [
                                @if (topVendors != null && topVendors.Any())
                                {
                                    @Html.Raw(string.Join(", ", topVendors.Select(v => $"'{v.VendorName}'")))
                                }
                                else
                                {
                                    <text>'No data'</text>
                                }
                            ],
                            labels: {
                                formatter: function(val) {
                                    return 'Rp ' + (val / 1000000).toFixed(0) + 'M';
                                }
                            }
                        },
                        tooltip: {
                            y: {
                                formatter: function(val) {
                                    return 'Rp ' + val.toLocaleString('id-ID');
                                }
                            }
                        }
                    };

                    try {
                        var topVendorsChart = new ApexCharts(topVendorsChartElement, topVendorsOptions);
                        topVendorsChart.render();
                    } catch (err) {
                        console.error("Error rendering Top Vendors chart:", err);
                        topVendorsChartElement.innerHTML = "<div class='alert alert-danger'>Could not load chart</div>";
                    }
                }

                // Spending by Category Chart (Donut)
                var categoryChartElement = document.querySelector("#category_spending_chart");
                if (categoryChartElement) {
                    var categorySpendingOptions = {
                        series: [
                            @if (spendingByCategory != null && spendingByCategory.Any())
                            {
                                @Html.Raw(string.Join(", ", spendingByCategory.Select(c => c.TotalSpending)))
                            }
                            else
                            {
                                <text>100</text>
                            }
                        ],
                        chart: {
                            type: 'donut',
                            height: 280
                        },
                        labels: [
                            @if (spendingByCategory != null && spendingByCategory.Any())
                            {
                                @Html.Raw(string.Join(", ", spendingByCategory.Select(c => $"'{c.CategoryName}'")))
                            }
                            else
                            {
                                <text>'No data'</text>
                            }
                        ],
                        colors: ['#667eea', '#764ba2', '#28a745', '#ffc107', '#17a2b8', '#dc3545'],
                        legend: { position: 'bottom' },
                        tooltip: {
                            y: {
                                formatter: function(val) {
                                    return 'Rp ' + val.toLocaleString('id-ID');
                                }
                            }
                        }
                    };

                    try {
                        var categorySpendingChart = new ApexCharts(categoryChartElement, categorySpendingOptions);
                        categorySpendingChart.render();
                    } catch (err) {
                        console.error("Error rendering Category Spending chart:", err);
                        categoryChartElement.innerHTML = "<div class='alert alert-danger'>Could not load chart</div>";
                    }
                }

            } catch (err) {
                console.error("Error in chart initialization:", err);
            }
        });
    </script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Prepare data for Monthly Request Trend
        const monthlyTrendData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthlyTrend ?? new List<object>()));
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const requestCounts = months.map((m, i) => {
            const found = monthlyTrendData.find(x => x.Month === i + 1);
            return found ? found.Count : 0;
        });
        const requestAmounts = months.map((m, i) => {
            const found = monthlyTrendData.find(x => x.Month === i + 1);
            return found ? found.TotalAmount / 1000000 : 0; // In millions
        });

        const ctx = document.getElementById('monthly_trend_chart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Request Count',
                        data: requestCounts,
                        borderColor: '#6259ca',
                        backgroundColor: 'rgba(98, 89, 202, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Amount (Millions)',
                        data: requestAmounts,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (M)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    </script>
}
