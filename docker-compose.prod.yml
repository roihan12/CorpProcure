version: '3.8'

services:
  # ============================================
  # CORPPROCURE APPLICATION
  # ============================================
  app:
    build: .
    container_name: corpprocure-app
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:3000
      - ConnectionStrings__DefaultConnection=Server=db;Database=corpProcure;User=sa;Password=${DB_PASSWORD:-YourStrong@Passw0rd!};TrustServerCertificate=true
      - EmailSettings__SmtpHost=${SMTP_HOST:-sandbox.smtp.mailtrap.io}
      - EmailSettings__SmtpPort=${SMTP_PORT:-2525}
      - EmailSettings__SmtpUsername=${SMTP_USERNAME}
      - EmailSettings__SmtpPassword=${SMTP_PASSWORD}
      - EmailSettings__FromEmail=${SMTP_FROM_EMAIL:-noreply@corpprocure.com}
      - EmailSettings__FromName=${SMTP_FROM_NAME:-CorpProcure System}
      - EmailSettings__EnableSsl=true
      - EmailSettings__IsEnabled=true
    depends_on:
      db:
        condition: service_healthy
    networks:
      - corpprocure-network
    restart: unless-stopped

  # ============================================
  # SQL SERVER DATABASE
  # ============================================
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: corpprocure-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD:-YourStrong@Passw0rd!}
    ports:
      - "1433:1433"
    volumes:
      - sqldata:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "${DB_PASSWORD:-YourStrong@Passw0rd!}" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - corpprocure-network
    restart: unless-stopped

  # ============================================
  # JENKINS CI/CD SERVER
  # ============================================
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    privileged: true
    user: root
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
    networks:
      - corpprocure-network
    restart: unless-stopped

  # ============================================
  # NGINX REVERSE PROXY
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot_webroot:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    depends_on:
      - app
      - jenkins
    networks:
      - corpprocure-network
    restart: unless-stopped

  # ============================================
  # CERTBOT (SSL CERTIFICATE)
  # ============================================
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - corpprocure-network

networks:
  corpprocure-network:
    driver: bridge

volumes:
  sqldata:
  jenkins_data:
  certbot_webroot:
  certbot_certs:
